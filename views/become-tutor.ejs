<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>boilerplate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/layouts/app.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .dropdown-toggle {
            width: 100%,
        }

        .checkbox-wrapper {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
    </style>
</head>

<body style="background-color: lightblue;">
    <%- include('./partials/tutor-navbar')%>
        <div class="container-fluid mt-3 pt-3">
            <div class="row mt-3 pt-3">
                <div class="col-6 offset-3 p-3 my-3">

                    <form class="form-control">
                        <div class="text-center">
                            <h4 id="tutorName">Betty, welcome to your tutor journey!</h4>
                        </div>
                        <!-- select past taken courses, and optionally add description to display -->
                        <div class="mt-3 mb-3">
                            <span>Which courses do you select to tutor?</span>
                            <div id="courses" class="checkbox-wrapper">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="course1" value="CS3443"
                                        onclick="checkCourse(this)">
                                    <label class="form-check-label" for="course1">CS3443</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="course2" value="FT5001"
                                        onclick="checkCourse(this)">
                                    <label class="form-check-label" for="course2">FT5001</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="course3" value="IT5007"
                                        onclick="checkCourse(this)">
                                    <label class="form-check-label" for="course3">IT5007</label>
                                </div>
                            </div>
                            <div id="wrapper" class="after-checkbox-wrapper">
                                <span>Add a brief description of what you can offer for the course (optional) </span>
                            </div>
                        </div>
                        <!-- gender and level -->
                        <div class="mt-3 mb-3">
                            <span>Please select your gender and degree level:</span>
                            <div>
                                <input type="radio" name="gender" value="F"checked>Female</input>
                                <input type="radio" name="gender" value="M">Male</input>
                            </div>
                            <div>
                                <input type="radio" name="level" value="B" checked>Bachelor</input>
                                <input type="radio" name="level" value="M" >Master</input>
                                <input type="radio" name="level" value="D">Doctor</input>
                            </div>
                        </div>



                        <!-- about me -->
                        <div class="mt-3 mb-3">
                            <div class="form-group">
                                <label for="exampleFormControlTextarea1">What do you want to display as a brief
                                    introduction
                                    of
                                    yourself?</label>
                                <textarea class="form-control" id="selfIntroduction" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- add image -->
                        <div class="mt-3 mb-3">
                            <span>What do you want to display as your profile picture?</span>
                            <div class="input-group">
                                <label class="input-group-text" for="inputGroupFile01">Upload</label>
                                <input type="file" class="form-control" id="inputGroupFile01">
                            </div>

                        </div>

                        <!-- time availability -->
                        <div class="mt-3 mb-3">
                            <span>What is your time availability?</span>
                            <div class="text-muted">Start time of Day</div>
                            <div class="btn-group1" role="group" aria-label="Basic radio toggle button group">
                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio8" value="8" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio8">8</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio9" value="9" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio9">9</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio10" value="10" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio10">10</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio11" value="11" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio11">11</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio12" value="12" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio12">12</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio13" value="13" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio13">13</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio14" value="14" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio14">14</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio15" value="15" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio15">15</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio16" value="16" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio16">16</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio17" value="17" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio17">17</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio18" value="18" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio18">18</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio19" value="19" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio19">19</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio19" value="19" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio19">19</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio20" value="20" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio20">20</label>

                                <input type="radio" class="btn-check" name="btnradio1" id="btnradio21" value="21" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio21">21</label>


                            </div>
                            
                            <!-- day of week -->
                            <div class="text-muted">Day of Week</div>
                            <div class="btn-group1" role="group" aria-label="Basic radio toggle button group">
                                <input value="1" type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off"
                                    checked>
                                <label class="btn btn-success" for="btnradio1" >MON</label>

                                <input type="radio" value="2" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
                                <label class="btn btn-success" for="btnradio2" >TUE</label>

                                <input type="radio" class="btn-check" name="btnradio" value="3" id="btnradio3" autocomplete="off">
                                <label class="btn btn-success" for="btnradio3">WED</label>
                                <input type="radio" class="btn-check" name="btnradio" value="4" id="btnradio4" autocomplete="off">
                                <label class="btn btn-success" for="btnradio4">THU</label>
                                <input type="radio" class="btn-check" name="btnradio" value="5" id="btnradio5" autocomplete="off">
                                <label class="btn btn-success" for="btnradio5">FRI</label>
                                <input type="radio" class="btn-check" name="btnradio" value="6" id="btnradio6" autocomplete="off">
                                <label class="btn btn-success" for="btnradio6">SAT</label>
                                <input type="radio" class="btn-check" name="btnradio" value="7" id="btnradio7" autocomplete="off">
                                <label class="btn btn-success" for="btnradio7">SUN</label>
                            </div>
                        </div>
                        <div>
                            <input onClick="handleAddSlot(this.form)" type="button" class="btn btn-success form-control mt-3" value="Add slot"></input>
                        </div>
                        <div id="available">

                        </div>
                        <!-- price range -->
                        <div class="mt-3 mb-3">
                            <span>What is your preferred price range?</span>
                            <select name="price" class="form-select" aria-label="Default select example">
                                <option selected>Price range</option>
                                <option value=[15,25]>$15 - 25 / h</option>
                                <option value=[26,35]>$26 - 35 / h</option>
                                <option value=[36,45]>$36 - 45 / h</option>
                            </select>
                        </div>


                        <div class="text-center mt-3 mb-3">
                            <input type="button" onClick="handleSubmit(this.form)" class="btn btn-success form-control mt-3" value="Submit Application"></input>
                        </div>
                    </form>






                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
            integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
            integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
            crossorigin="anonymous"></script>
        <script src="../../bootstrap/js/bootstrap.bundle.min.js"></script>
        <script>
            var descCourse = document.querySelector(".after-checkbox-wrapper");
            descCourse.style.display = "none";
            
            // activate nav link
            (() => {
                var element = document.getElementById("navBecome");
                element.classList.add("active");
            })();

            window.addEventListener('load', loadHandler);

            async function loadHandler(){
                var username = sessionStorage.getItem('username');
                var name ='';
                var courses = [];
                const query = `query {
                    AllUsers{
                    username
                    name
                    courses
                    }
                }`;//no ()
                const data = await graphQLFetch(query);
                
                var AllUsers = data.AllUsers;
                for(let i = 0; i < AllUsers.length; i++){
                    if(username == AllUsers[i].username){
                        name = AllUsers[i].name;
                        courses = AllUsers[i].courses;
                    }
                }
                document.getElementById("tutorName").innerText = name + ", welcome to your tutor journey!";
                console.log(courses.length);
                var str = '';
                for(let i = 0; i < courses.length; i++){
                    
                    str += '<div class="form-check form-switch">'
                                    + '<input class="form-check-input" type="checkbox" onclick="checkCourse(\''+courses[i]+'\')">'
                                    + '<label class="form-check-label" for="course1">' + courses[i] +'</label>'
                                + '</div>'
                }
                document.getElementById("courses").innerHTML = str;
            }

            var offeredCourses = [];
            
            function checkCourse(course){
                if(offeredCourses.indexOf(course) == -1){//add
                    offeredCourses.push(course);
                    var str = document.getElementById("wrapper").innerHTML;

                    str += '<div class="input-group mb-3">'
                                    +'<div class="input-group-prepend">'
                                        +'<span class="input-group-text" id="inputGroup-sizing-default">' + course + '</span>'
                                    +'</div>'
                                    +'<input id='+ course +'type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">'
                                +'</div>';
                    document.getElementById("wrapper").innerHTML = str;
                    var descCourse = document.querySelector(".after-checkbox-wrapper");
                    descCourse.style.display = "block";
                } else {//remove
                    var index = offeredCourses.indexOf(course);
                    offeredCourses.splice(index,1);
                    var str = '<span>Add a brief description of what you can offer for the course (optional) </span>';
                    for(let i = 0; i<offeredCourses.length; i++){
                        str += '<div class="input-group mb-3">'
                                    +'<div class="input-group-prepend">'
                                        +'<span class="input-group-text" id="inputGroup-sizing-default">' + offeredCourses[i] + '</span>'
                                    +'</div>'
                                    +'<input type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">'
                                +'</div>';
                    }
                    document.getElementById("wrapper").innerHTML = str;
                    if(offeredCourses.length == 0){
                        var descCourse = document.querySelector(".after-checkbox-wrapper");
                        descCourse.style.display = "none";
                    }

                }
                
            }
            var availability = [];

            function handleAddSlot(form){
                var time = form.btnradio1.value;
                var day = form.btnradio.value;
                var slot = day + '-' + time;
                if(availability.indexOf(slot) != -1){
                    availability.splice(availability.indexOf(slot),1);
                }
                else {
                    availability.push(slot);
                }
                var str = '';
                var Day = ['','Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

                for(let i=0; i<availability.length; i++) {
                    let len = availability[i].length;
                    if(len == 3){
                        var time = availability[i][2];
                    }
                    else {
                        var time = availability[i][2] + '' + availability[i][3];
                    }
                    endTime = parseInt(time)+1;
                    
                    str += '<p>' + Day[availability[i][0]] + ': ' + time + ':00 ~ ' + endTime + ':00' + '</p>';
                }

                document.getElementById("available").innerHTML= str;
                console.log(availability);
            }


            async function handleSubmit(form){    
                var courseType = [];
                for(let i=0; i<offeredCourses.length; i++){
                    if(offeredCourses[i].length == 6){
                        let type = offeredCourses[i][0]+''+offeredCourses[i][1];
                        courseType.push(type);
                    } else {
                        let type = offeredCourses[i][0]+''+offeredCourses[i][1]+''+offeredCourses[i][2];
                        courseType.push(type);
                    }
                }
                var courses = offeredCourses;
                var price = form.price.value;
                var intro = form.selfIntroduction.value;
                var gender = form.gender.value;
                var level = form.level.value;

                if(!(courseType&&courses&&price&&intro&&gender&&level)){
                    alert("Please complete the form before submitting.")
                }
                var tutor = {
                    username: sessionStorage.getItem('username'),
                    gender: gender,
                    courseType: courseType,
                    courses: courses,
                    price: price,
                    availability: availability,
                    level: level,
                    degree: '',
                    completedLessons: 0,
                    numReviews: 0,
                    stars: 0,
                    intro: intro
                }
                const query = `mutation TutorAdd($tutor: TutorInput!){
                    TutorAdd(tutor: $tutor)
                    {
                    username
                    }
                }`;
                const data = await graphQLFetch(query, { tutor });
                if(data.TutorAdd.length){
                    alert("Successfully registered.");
                }
                else alert("Failed. You are a tutor already.");
            }
            


            const dateRegex = new RegExp('^\\d\\d\\d\\d-\\d\\d-\\d\\d');
            async function graphQLFetch(query, variables = {}) {
            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    withCredentials: true,
                    body: JSON.stringify({ query, variables })
                });
                const body = await response.text();

                const result = JSON.parse(body, jsonDateReviver);
  
                if (result.errors) {
                    const error = result.errors[0];
                    if (error.extensions.code == 'BAD_USER_INPUT') {
                        const details = error.extensions.exception.errors.join('\n ');
                        alert(`${error.message}:\n ${details}`);
                    } else {
                        alert(`${error.extensions.code}: ${error.message}`);
                    }
                }
                return result.data;
                } catch (e) {
                alert(`Error in sending data to server: ${e.message}`);
                }
            }

            function jsonDateReviver(key, value) {
                if (dateRegex.test(value)) return new Date(value);
                return value;
            }
        </script>
</body>

</html>