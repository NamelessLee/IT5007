<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>boilerplate</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/layouts/app.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        .dropdown-toggle {
            width: 100%;
        }
        
    </style>
    <script language="Javascript">
        
        

        function chat(stu){
            document.getElementById("msgs").style.display="none";
            document.getElementById("chat").style.display="block";
            document.getElementById("calendar").style.display="block";

            document.getElementById("chatTitle").innerText = 'Chat With ' + stu;
        }
        function backToTotorHome(){
            document.getElementById("msgs").style.display="block";
            document.getElementById("chat").style.display="none";
            document.getElementById("calendar").style.display="none";
        }
        function generateOrder(){

        }
    </script>
    
</head>

<body style="background-color: lightblue;">
  <div>
    <%- include('./partials/tutor-navbar')%>
  </div>
  <br></br><br>


  <div class="row">
    <div class="col-3">
      <div id="tutorlogin"
        style="display: block; margin: 20px; padding:20px;  border:peachpuff 2px solid; border-radius:10px; background-color: white; float:left;width:85%">
        <form>
          <legend>Tutor Login</legend>
          <div class="mb-3">
            <label for="exampleInputEmail1" class="form-label">Username</label>
            <input type="email" class="form-control" name="username" aria-describedby="emailHelp">
          </div>
          <div class="mb-3">
            <label for="exampleInputPassword1" class="form-label">Password</label>
            <input type="password" class="form-control" name="password">
          </div>
          <button type="button" class="btn btn-primary" onClick="tutorLogin(this.form)">Submit</button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </form>
      </div>
      <div class="card" id="helloTutor"
        style="display: none; margin: 20px; padding:20px;  border:peachpuff 2px solid; border-radius:10px; background-color: white; float:left;width:85%">
        <img src="./img/tutorPhoto.jpeg" class="card-img-top" alt="...">
        <div class="card-body">
          <h5 id="tutorDetailName" class="card-title">Tom Smith</h5>
          <p id="tutorDetailIntro"  class="card-text">I love tutoring and have spent thousands of hours conducting tutorials myself as well as
            being the student.</p>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><label>Offers:</label>
            <div id="tutorDetailTypes" style="float:right">CS, IS</div>
          </li>
          <li class="list-group-item"><label>Rate:</label>
            <div id="tutorDetailRate" style="float:right">5.0</div>
          </li>
          <li class="list-group-item"><label>Completed Lessons:</label>
            <div id="tutorDetailCompletedLessons"  style="float:right">210</div>
          </li>
          <li class="list-group-item"><label>Tuition Fee:</label>
            <div id="tutorDetailFee" style="float:right">$40~60/h</div>
          </li>
          <li class="list-group-item"><label>Degree:</label>
            <div id="tutorDetailDegree" style="float:right">Master</div>
          </li>
        </ul>
        <div class="card-body">
          <a style="margin-bottom: 10px;" href="#" class="btn btn-primary">My reviews</a><br>
          <a style="margin-bottom: 10px;" href="#" class="btn btn-primary">My completed lessons</a><br>
          <a style="margin-bottom: 10px;" href="#" class="btn btn-primary">Edit my profile</a>
          <a style="margin-bottom: 10px;" href="#" class="btn btn-danger">Help</a>
        </div>
      </div>
    </div>
    <div class="col-6" id="chat" style="display:none; margin-top: 23px;">
        <div style="margin-right: 50px;">
            <span id="chatTitle" style="border:aqua 1px solid; border-radius: 10px; font-size:30px; background-color: white; padding:10px; color:rgb(93, 231, 231)">
                    Chat with Lang Qianqian  
            </span>
            
            <button type="button" onclick="backToTotorHome()" style="float: right; padding:10px 10px 0px 10px; border:brown 3px solid; border-radius:10px; background-color:rgb(255, 162, 70);"><h4>Back</h4></button>
            <button type="button" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="generateOrder()" style="float: right; padding:10px 10px 0px 10px; border:rgb(255, 162, 70) 3px solid; border-radius:10px; background-color:peachpuff;"><h4>Generate Order</h4></button>    
        </div>
        <br>
        <div id="chat">
            <%- include('./chatbox')%>
        </div>
            
        <div id="calendar" style="position:absolute; top:200px; margin-right: 400px; text-align: center; border:rgb(252, 145, 52) 1px solid; border-radius: 10px; background-color: peachpuff;">
            <h4>My Calendar</h4>
            <img src="./img/calendar.jpg" class="img-fluid" alt="...">
        </div>

        
    </div>
    <div class="col-6" id="msgs" style="display: none;">
        <div style=" margin: 20px; padding:20px;  border:peachpuff 2px solid; border-radius:10px; background-color: white; float:right; width:100%">
            <h3>My Messages</h3>
            <ol class="list-group ">
            <a href="javascript:void(0);" onclick="chat('Lang Qianqian')" class="list-group-item list-group-item-action">
                <li style="border:0px" class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="ms-2 me-auto">
                    <div class="fw-bold">Lang Qianqian</div>
                    Good evening, I'm very happy with our last tutor session. May I book your next week's same time slot for another toturing?
                  
                </div>
                <small style="color: gray;">1 hour ago</small>
                  <span class="badge bg-primary rounded-pill">1</span>
                </li>
            </a>
            <a href="#" onclick="chat('Li Xinyue')" class="list-group-item list-group-item-action">
                <li style="border:0px" class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="ms-2 me-auto">
                    <div class="fw-bold">Li Xinyue</div>
                    Hi, I'm interested in your CS modules tutoring. I want to find someone help me with my labs. :)
                  </div>
                  <small style="color: gray;">1 day ago</small>
                  <span class="badge bg-primary rounded-pill">2</span>
                </li>
            </a>
            <a href="#" onclick="chat('John')" class="list-group-item list-group-item-action">
                <li style="border:0px" class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="ms-2 me-auto">
                    <div class="fw-bold">John</div>
                    Could you help me with this problems in the photos I have sent above? Thanks!
                  </div>
                  <small style="color: gray;">2 days ago</small>
                  <span class="badge bg-primary rounded-pill">5</span>
                </li>
            </a>
              </ol>
        </div>
    </div>
    <div class="col-3" id="notifications" style="display: none;">
        <div  style="margin: 20px; padding:20px;  border:peachpuff 2px solid; border-radius:10px; background-color: white; float:right; width:100%">
            <h3>Notifications</h3>
            <button style="margin-right:2px" type="button" class="btn btn-outline-primary position-relative">
                Order
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  2
                  <span class="visually-hidden">unread messages</span>
                </span>
              </button>
              <button style="margin:2px" type="button" class="btn btn-outline-primary position-relative">
                Review
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  1
                  <span class="visually-hidden">unread messages</span>
                </span>
              </button>
              <button style="margin:2px" type="button" class="btn btn-outline-primary position-relative">
                Rate
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  1
                  <span class="visually-hidden">unread messages</span>
                </span>
              </button>
              <button style="margin-left:2px" type="button" class="btn btn-outline-primary position-relative">
                Fee
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  1
                  <span class="visually-hidden">unread messages</span>
                </span>
              </button>
                <div style="margin-top: 20px;">
                    <h3>Upcoming Tutorials</h3>
                    <div class="card text-dark bg-light mb-3" style="max-width: 18rem;">
                        <div class="card-header">CS5001</div>
                        <div class="card-body">
                        <h5 class="card-title">Tomorrow 14:00~15:00</h5>
                            <p class="card-text">
                                <div>With: Racheal Green</div>
                                Help with coding assignment1: To reverse a linked list.
                            </p>
                        </div>
                    </div>
                    <div class="card text-dark bg-light mb-3" style="max-width: 18rem;">
                        <div class="card-header">IS5002</div>
                        <div class="card-body">
                        <h5 class="card-title">Sunday 9:00~11:00</h5>
                            <p class="card-text">
                                <div>With: Monica Geller</div>
                                Review slides and textbook of chapter 2. Help with quiz questions on the textbook. Help with homework of chapter 2. 
                            </p>
                        </div>
                    </div>
                </div>
                

        </div>
      </div>
       
    <div id="img" class="col-8" style="display: block;">
      <h2
        style="text-align: center; background-color: peachpuff; border:peru 1px solid; border-radius: 10px; padding:5px">
        Login To Find More</h2>
        <img class="container-fluid" src="./img/tutorial.png">
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Generate Order</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form>
                  <div class="mb-3">
                      <label class="form-label">Student Name: Lang Qianqian</label>
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Student ID: A0242694X</label>
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Tutor Name: Tom Smith</label>
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Tutor ID: A0242720R</label>
                  </div>
                  <div class="mb-3">
                    <label for="exampleInputEmail1" class="form-label">Module:</label>
                    <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">
                  </div>
                  <div class="mb-3">
                    <label for="exampleInputPassword1" class="form-label">Time:</label>
                    <input type="password" class="form-control">
                  </div>
                  <div class="mb-3">
                      <label for="exampleInputPassword1" class="form-label">Fee:</label>
                      <input type="password" class="form-control" >
                  </div>
                  <div class="mb-3">
                      <label for="exampleInputPassword1" class="form-label">Location:</label>
                      <input type="password" class="form-control">
                  </div>
                  <button type="submit" class="btn btn-primary">Submit</button>
                  <button type="reset" class="btn btn-secondary">Reset</button>
                </form>
          </div>
        </div>
      </div>
    </div>
  </div>




  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script>
    // activate nav link
    (() => {
      var element = document.getElementById("navLogin");
      element.classList.add("active");
    })();

    const dateRegex = new RegExp('^\\d\\d\\d\\d-\\d\\d-\\d\\d');
            async function graphQLFetch(query, variables = {}) {
            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    withCredentials: true,
                    body: JSON.stringify({ query, variables })
                });
                const body = await response.text();

                const result = JSON.parse(body, jsonDateReviver);
  
                if (result.errors) {
                    const error = result.errors[0];
                    if (error.extensions.code == 'BAD_USER_INPUT') {
                        const details = error.extensions.exception.errors.join('\n ');
                        alert(`${error.message}:\n ${details}`);
                    } else {
                        alert(`${error.extensions.code}: ${error.message}`);
                    }
                }
                return result.data;
                } catch (e) {
                alert(`Error in sending data to server: ${e.message}`);
                }
            }

            function jsonDateReviver(key, value) {
                if (dateRegex.test(value)) return new Date(value);
                return value;
            }

    async function tutorLogin(form){
          var tutor = {
            username: form.username.value,
            password: form.password.value
          }
          const query = `query {
                  TutorLogin(tutor: {username: "${tutor.username}", password: "${tutor.password}"})
                  {
                      username
                      gender
                      courseType
                      courses
                      price
                      availability
                      level
                      degree
                      completedLessons
                      numReviews
                      stars
                      intro
                  }
              }`;
             
          var data = await graphQLFetch(query, { tutor });
          //console.log(JSON.stringify(data));
          var TutorLogin = data.TutorLogin;
          if(TutorLogin.length == 0){
            alert("Failed. Incorrect username or password.");
          }
            else {
              renderTutorDetail(TutorLogin[0]);
            }
        }

        async function renderTutorDetail(tutor){
         
              document.getElementById("tutorlogin").style.display= "none";
              document.getElementById("helloTutor").style.display= "block";
              document.getElementById("notifications").style.display= "block";
              document.getElementById("msgs").style.display= "block";
              document.getElementById("img").style.display= "none";

              const query = `query {
                AllUsers{
                  username
                  password
                  name
                  type
                  dorm
                  courses
                }
              }`;//no ()
              const data = await graphQLFetch(query);
              var name = '';
              for(let i=1; i<data.AllUsers.length;i++){
                if(data.AllUsers[i].username == tutor.username){
                  name = data.AllUsers[i].name;
                }
              }
              console.log(tutor);
              var Types = '';
              for(let i = 0; i < tutor.courses.length; i++){
                Types += tutor.courses[i] + ', '
              }
              var Degree = 'Bachelor';
              if(tutor.level =='D'){
                Degree = 'Doctor';
              } else if(tutor.level == 'M'){
                Degree = 'Master'
              }
              
              
              document.getElementById("tutorDetailName").innerText = name;
              document.getElementById("tutorDetailIntro").innerText = tutor.intro;
              document.getElementById("tutorDetailTypes").innerText = Types;
              document.getElementById("tutorDetailRate").innerText = tutor.stars;
              document.getElementById("tutorDetailCompletedLessons").innerText = tutor.completedLessons;
              document.getElementById("tutorDetailFee").innerText = '$' + tutor.price[0] + '~' + tutor.price[1] + '/h';
              document.getElementById("tutorDetailDegree").innerText = Degree;

        }
  </script>
</body>

</html>